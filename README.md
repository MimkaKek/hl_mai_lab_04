# Домашняя работа №4 - Data Cache

## Цель

Получение практических навыков в построении сервисов, требующих высокую скорость отклика при работе с данными.

## Задание

Необходимо модифицировать приложение, которое было создано в предыдущем задании. 
Для сущности, отвечающей за хранение клиента (пользователя) необходимо настроить настроить кеширование.

Должны выполняться следующие условия:
- Кеш должен быть реализован с помощью Redis
- Записи в кеше должны иметь срок жизни
- Необходимо реализовать шаблоны «сквозное чтение» и «сквозная
запись»
- Необходимо провести сравнение время отклика и максимальной 
пропускной способности сервиса по запросу данных клиента
(пользователя) с помощью утилиты wrk с использованием кеша и без
него. Результат тестирования сохранить в репозитории в файле
performance.md

## Решение

В этой лабораторной реализован Gateway, который по сути отвечает за то, чтобы принимать все запросы к сервисам из вне, и перенаправлять их сервисам. Да, в следующей лабораторной как раз и требуется нечто подобное, но тут для этого есть причина. Пробовал для каждого сервиса отдельно прописать взаимодействие с Redis, но это показалось крайне сомнительным из-за того, что по сути код множество раз дублировался - это как минимум усложнило бы отладку и поддержку. Искал другие места, но безуспешно.

Посмотрел пример Дзюбы - там как раз и был реализован в некоторой степени Gateway. Взял его за основу и переработал, заодно переписав некоторые свои функции и реализовав новые, когда заметил некоторые интересные идеи.

Поэтому конечная схема следующая:
- Пользователь обращается к Gateway (порт 8888);
- Gateway обращается сначала к Redis, пытаясь получить релевантные данные для запроса;
- Если данные есть - выдаёт ответ пользователю. Если нет - начинает поиск актуальных данных у сервисов;
- Сначала идёт обращение к сервису пользователей для получения JWT токена;
- Если JWT токен получен - идёт запрос к нужному сервису. Ответ сервиса сохраняется в Redis и затем передаётся уже пользователю.

По итогу тестирования при помощи ```wrk``` скорость выросла в разы. Объясняется это тем, что пропускается этап с авторизацией пользователя и обращения к сервису. Скрипт, по которому генерировались запросы, находится в файле ```get.lua```

## Справочная информация

### OpenAPI 3.0 
Он оказался слишком громоздким для одного файла index.yaml, поэтому я разделил на 4 файла (на каждый сервис) и поместил в папку [docs](https://github.com/MimkaKek/hl_mai_lab_04/tree/main/docs). 

Gateway по сути реализует все указанные там запросы, но по порту 8888.

### Запуск
Для запуска достаточно команды

```
docker compose up
```

### Заполнение БД
Скрипт заполнения баз данных реализован в файле [init_db.py](https://github.com/MimkaKek/hl_mai_lab_04/blob/main/init_db.py). К нему прилагаются нужные пакеты в [requerments.txt](https://github.com/MimkaKek/hl_mai_lab_04/blob/main/requirements.txt).
